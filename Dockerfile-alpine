FROM node:14-alpine AS builder

ARG GITHASH
ARG TIMESTAMP
ARG COMPONENT
ARG MODULE
ARG CUSTOMER
ARG PROJECT
ARG VARIANT
ARG BUILDDIR=.

ENV GITHASH=$GITHASH
ENV TIMESTAMP=$TIMESTAMP
ENV COMPONENT=$COMPONENT
ENV MODULE=$MODULE
ENV CUSTOMER=$CUSTOMER
ENV PROJECT=$PROJECT
ENV VARIANT=$VARIANT

COPY $BUILDDIR /opt/fe-weatherstation/
WORKDIR /opt/fe-weatherstation

RUN apk add make bash
RUN make all

FROM nginx:stable-alpine

ARG GITHASH
ARG TIMESTAMP
ARG COMPONENT
ARG MODULE
ARG CUSTOMER
ARG PROJECT
ARG VARIANT
ARG BUILDDIR=.

ENV GITHASH=$GITHASH
ENV TIMESTAMP=$TIMESTAMP
ENV COMPONENT=$COMPONENT
ENV MODULE=$MODULE
ENV CUSTOMER=$CUSTOMER
ENV PROJECT=$PROJECT
ENV VARIANT=$VARIANT

COPY --from=builder /opt/fe-weatherstation/dist/weatherstation-fe /usr/share/nginx/html
COPY $BUILDDIR/app.conf /etc/nginx/conf.d
RUN chown root:root /etc/nginx/conf.d/app.conf && \
    chmod 0644      /etc/nginx/conf.d/app.conf

LABEL GITHASH=${GITHASH}
LABEL TIMESTAMP=${TIMESTAMP}
LABEL COMPONENT=${COMPONENT}
LABEL MODULE=${MODULE}
LABEL CUSTOMER=${CUSTOMER}
LABEL PROJECT=${PROJECT}
LABEL VARIANT=$VARIANT
